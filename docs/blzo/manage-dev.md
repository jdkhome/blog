# BLZO管理后台开发指南

本文旨在帮助开发者:
- 理解blzo-ex-authj权限框架的原理
- 基于BLZO脚手架自带管理后台对业务功能进行开发
- 基于blzo-ex-authj开发自己的管理后台(如果你不愿意使用BLZO自带的后台的话..)

## blzo-ex-authj 原理

### 权限管理的现状

提到权限管理，其实市面上以及有相当多的权限框架了，比如：shiro 、 spring security 等等。

而提到拥有权限管理的管理后台脚手架，这就更加多了，[在码云上搜索脚手架](https://gitee.com/search?utf8=%E2%9C%93&q=%E8%84%9A%E6%89%8B%E6%9E%B6)，基本上都有这些功能。

但在这个什么都有的年代，我最终还是又造了一遍轮子，站在巨人的肩膀上，我希望这个轮子能够更进一步的减少开发者与使用者的工作。

#### 痛点一: 权限实体该由谁维护

何为权限实体？权限管理系统中，到底能管理哪些权限？  

一般来说 管理权限实体有2个方案：

1. 做成权限配置文件，比如shiro就可以使用权限配置文件来管理角色和uri。
2. 做成权限实体表，然后功能发布了，由使用者或者开发者登陆系统配置。

但是这两种方案带来的维护成本都不小，方案一很大程度上就限制了用户管理权限的自由性，而方案二，接口新增和变更都需要同步去维护权限实体表，这些工作，会在高速迭代的产品中愈发显现。

authj权限框架则提出了一个新的模式，系统中有哪些权限实体，是由这个系统中已有的功能决定的，程序启动时，authj会扫描系统中已有的功能，以此生成权限实体！

#### 痛点二: 权限管理的粒度

最常见的权限管理模型是 角色权限模型。 除了权限实体外，额外引入角色概念，指定每个角色能干哪些事情，并为每个管理员设置1个或多个角色身份，以此来实现细粒度的权限管理。

然而，这样的权限管理模型，每当需要进行权限变更的时候，都需要由拥有"角色管理"权限的账户来进行操作。这样随着运营后台使用人数的增加，势必会使拥有"角色管理"权限的账户频繁的操作以应对各种的权限分配需求。

就好比是，我是一个运营小组长，我想在我的有权范围管理我的2个下属的权限，这样的需求，需要去求助运营总监、或者行政总监才能完成！

authj权限框架并没有使用角色权限模型，而是提出了另一个模型: 权限组叠加。  
基于这个模型，用户可以很方便的将自己拥有的权限赋予给其他人，而不用求助于顶级管理员或者开发者。

### authj的工作原理

authj的工作原理主要在以下3点:

- 权限实体自动扫描
- 使用权限组实现权限传递
- 登陆时为session授权

#### 权限实体自动扫描

权限实体(也简称"权限")代表了具体的功能点，可以是某一个页面(如:商品列表页)，也可以是某一个按钮/功能(如:添加商品)。

在spring boot的代码中，其实就是controller层的方法，要么对应接口、要么对应页面。

使用authj权限框架，需要在controller层的方法上增加**@Authj**注解，管理后台项目启动时，会根据controller的包配置，扫描到所有的@Authj注解，以此来生成权限实体。

#### 权限组与权限传递

每一个管理员都可以创建和管理自己的权限组(前提是该管理员有 "创建权限组" 的权限)。

权限组的管理分为 授权管理 和 成员管理。

管理员可以通过授权功能，将自己拥有的权限授权给权限组，通过添加成员功能，为自己的权限组添加成员。

当你处在一个权限组里，你就拥有这个这个权限组里的所有有效权限，我把这个过程称为:从权限组继承权限。

你可以把自己拥有的所有有效权限(无论是从谁的组里继承来的)，授权给自己创建的其他权限组，并将其传递给其他的管理员。

系统中 userId=0 的用户 为 超级管理员，不难看出所有用户的权限都是继承自超级管理员的。

这里提到了 **有效权限** ，权限组里拥有的权限必须和权限组的创建者所拥有的权限取交集，剩下的这些才能是有效权限。

换句话说，就是，如果权限组的创建者本身都没有这个权限，那么由他传递出去的该权限也是无效的。

以上就是权限组与权限传递的规则。

#### 授权

授权操作是在用户登陆的时候进行的，authj会根据具登陆用户继承权限的关系，为登陆的session授权。

登陆用户加入的所有组的有效权限取并集就是该session被授权的权限。

最后，authj的拦截器会在每次请求时，会检查请求对应的权限实体，当前session是否有权访问，以此进行鉴权操作。

### 数据字典

authj 共有6张表

```
- admins            管理员
- groups            权限组
- group_admin       权限组-管理员关联表
- group_auth        权限组-权限实体关联表
- logs              操作日志表
- organizes         组织表
```
